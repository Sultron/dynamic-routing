const D=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))n(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function e(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerpolicy&&(s.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?s.credentials="include":r.crossorigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(r){if(r.ep)return;r.ep=!0;const s=e(r);fetch(r.href,s)}};D();class B{constructor(t){this.map=t}extractKeys(t){let e=[];return Object.keys(t).forEach(n=>e.push(n)),e}sorter(t,e){return parseFloat(t)-parseFloat(e)}findPaths(t,e){let n={},r={"0":[t]},s={},c;const g=function(i,y){const o=""+i;r[o]||(r[o]=[]),r[o].push(y)};for(n[t]=0;r&&(c=this.extractKeys(r)).length;){c.sort(this.sorter);const i=c[0],y=r[i],o=y.shift(),d=parseFloat(i),h=this.map[o]||{};y.length||delete r[i];for(const p in h)if(h.hasOwnProperty(p)){const f=h[p],v=f+d,M=n[p];(M===void 0||M>v)&&(n[p]=v,g(v,p),s[p]=o)}}return n[e]===void 0?null:s}extractShortest(t,e){let n=[],r=e;for(;r!==void 0;)n.push(r),r=t[r];return n.reverse(),n}findShortestPath(t){let e=t.shift(),n,r,s=[],c;for(;t.length;){if(n=t.shift(),r=this.findPaths(e,n),r)if(c=this.extractShortest(r,n),t.length)s.push.apply(s,c.slice(0,-1));else return s.concat(c);else return null;e=n}}}var x="/dynamic-routing/assets/happy-router.a19dd149.png",R="/dynamic-routing/assets/dead-router3.b6433248.png";document.querySelector("#app").innerHTML=`
  <h1>Dynamic Routing Mechanism Design</h1>
  <h2>in Faulty Network</h2>
`;function u(){return Math.floor(Math.random()*10)+1}function I(l,t){document.getElementById("sourceNodeTitle").innerHTML=`<strong>Router ${t.replace(/^\D+/g,"")}</strong>`;let e={},n={},r=[];for(let g of l.nodes)n[g.id]=g.img===R,r.push(g.id);for(let g of l.edges)n[g.source]||n[g.target]||g.label!=="X"&&(e[g.source]=Object.assign({[g.target]:g.label},e[g.source]),e[g.target]=Object.assign({[g.source]:g.label},e[g.target]));let s=new B(e);var c=document.getElementById("tableBody");c.innerHTML="";for(let g of r){let i=s.findShortestPath([t,g]);if(!i)continue;let y=[];for(let f=0;f<i.length-1;f++)e[i[f]][i[f+1]]&&y.push(e[i[f]][i[f+1]]);i=i.join().match(/\d+/g).map(f=>"Router "+f);let o=c.insertRow(),d=o.insertCell(),h=o.insertCell(),p=o.insertCell();d.innerHTML=i[i.length-1],h.innerHTML=i.length>1?i[1]:i[0],p.innerHTML=y.reduce((f,v)=>f+v,0)}}var T,w;L();function L(){typeof window.innerWidth!="undefined"?(T=window.innerWidth,w=window.innerHeight):typeof document.documentElement!="undefined"&&typeof document.documentElement.clientWidth!="undefined"&&document.documentElement.clientWidth!=0?(T=document.documentElement.clientWidth,w=document.documentElement.clientHeight):(T=document.getElementsByTagName("body")[0].clientWidth,w=document.getElementsByTagName("body")[0].clientHeight)}window.addEventListener("resize",L);const N=[4,2,1,2];G6.registerEdge("line-dash",{afterDraw(l,t){const e=t.get("children")[0];let n=0;e.animate(()=>(n++,n>9&&(n=0),{lineDash:N,lineDashOffset:-n}),{repeat:!0,duration:3e3})}},"cubic");G6.registerEdge("circle-running",{afterDraw(l,t){const e=t.get("children")[0],n=e.getPoint(0);t.addShape("circle",{attrs:{x:n.x,y:n.y,fill:"red",r:3},name:"circle-shape"}).animate(s=>{const c=e.getPoint(s);return{x:c.x,y:c.y}},{repeat:!0,duration:3e3})}},"cubic");const H=new G6.Tooltip({offsetX:10,offsetY:10,fixToNode:[1,.5],itemTypes:["node","edge"],getContent:l=>{const t=document.createElement("div");if(t.style.width="fit-content",t.style.height="fit-content",l.item.getModel(),l.item.getType()==="node"){const e=l.item._cfg.edges.filter(n=>!k[n._cfg.id]).length;t.innerHTML=`${e>1?`${e} network paths`:`${e} network path`}`}else{const e=l.item.getSource(),n=l.item.getTarget();t.innerHTML=`<table>
      <tr>
        <th>Connection</th>
        <th>Cost</th>
      </tr>
      <tr>
        <td>${e.getModel().label} <br/>  ${n.getModel().label}</td>
        <td>${l.item.getModel().label}</td>
      </tr>
    </table>`}return t}});var k={};const a=new G6.Graph({container:"mountNode",width:T,height:w,animate:!0,fitView:!0,plugins:[H],modes:{default:["drag-canvas"]},defaultEdge:{type:"cubic",style:{lineWidth:2,stroke:"#bae7ff"}},defaultNode:{type:"image",img:x,label:"AntV Team",size:40}}),m=100,b={nodes:[{id:"node1",label:"Router 1",x:127/1.25,y:(558-m)/1.25},{id:"node2",label:"Router 2",x:187/1.25,y:(389-m)/1.25},{id:"node3",label:"Router 3",x:273/1.25,y:(249-m)/1.25},{id:"node4",label:"Router 4",x:498/1.25,y:(217-m)/1.25},{id:"node5",label:"Router 5",x:711/1.25,y:(160-m)/1.25},{id:"node6",label:"Router 6",x:420/1.25,y:(404-m)/1.25},{id:"node7",label:"Router 7",x:415/1.25,y:(570-m)/1.25},{id:"node8",label:"Router 8",x:611/1.25,y:(521-m)/1.25},{id:"node9",label:"Router 9",x:689/1.25,y:(372-m)/1.25},{id:"node10",label:"Router 10",x:902/1.25,y:(525-m)/1.25},{id:"node11",label:"Router 11",x:1080/1.25,y:(396-m)/1.25},{id:"node12",label:"Router 12",x:1313/1.25,y:(495-m)/1.25},{id:"node13",label:"Router 13",x:1223/1.25,y:(647-m)/1.25},{id:"node14",label:"Router 14",x:1435/1.25,y:(676-m)/1.25},{id:"node15",label:"Router 15",x:1506/1.25,y:(484-m)/1.25},{id:"node16",label:"Router 16",x:1399/1.25,y:(299-m)/1.25}],edges:[{id:"nodes1&2",label:u(),source:"node1",target:"node2"},{id:"nodes2&3",label:u(),source:"node2",target:"node3"},{id:"nodes2&6",label:u(),source:"node2",target:"node6"},{id:"nodes3&4",label:u(),source:"node3",target:"node4"},{id:"nodes4&5",label:u(),source:"node4",target:"node5"},{id:"nodes5&16",label:u(),source:"node5",target:"node16"},{id:"nodes6&4",label:u(),source:"node6",target:"node4"},{id:"nodes6&7",label:u(),source:"node6",target:"node7"},{id:"nodes6&9",label:u(),source:"node6",target:"node9"},{id:"nodes7&8",label:u(),source:"node7",target:"node8"},{id:"nodes8&9",label:u(),source:"node8",target:"node9"},{id:"nodes9&10",label:u(),source:"node9",target:"node10"},{id:"nodes10&11",label:u(),source:"node10",target:"node11"},{id:"nodes11&12",label:u(),source:"node11",target:"node12"},{id:"nodes11&13",label:u(),source:"node11",target:"node13"},{id:"nodes12&13",label:u(),source:"node12",target:"node13"},{id:"nodes12&14",label:u(),source:"node12",target:"node14"},{id:"nodes12&15",label:u(),source:"node12",target:"node15"},{id:"nodes12&16",label:u(),source:"node12",target:"node16"},{id:"nodes13&14",label:u(),source:"node13",target:"node14"},{id:"nodes14&15",label:u(),source:"node14",target:"node15"},{id:"nodes15&16",label:u(),source:"node15",target:"node16"}]};function C(){a.setAutoPaint(!1),a.getEdges().forEach(function(l){l.destroyed||a.clearItemStates(l)}),a.paint(),a.setAutoPaint(!0)}a.on("edge:click",l=>{let t=new bootstrap.Modal(document.getElementById("edgeCost"),{keyboard:!1});document.getElementById("cost-value").value=l.item.getModel().label,document.getElementById("edgeInfoMsg").textContent=`Update the cost link between Router ${l.item.getModel().source.replace(/^\D+/g,"")} and Router ${l.item.getModel().target.replace(/^\D+/g,"")}. Enter '-1' for a faulty link.`,document.getElementById("edgeCostBtn").addEventListener("click",()=>{let e=document.getElementById("cost-value").value,n={};e>>0==-1?n={label:"X"}:n={label:Math.abs(e>>0)},l.item.update(n),t.hide();let r=S(),s=r[0].value,c=r[1].value;E(a.save(),s,c)},{once:!0}),t.show()});document.getElementById("tutorialBtn").addEventListener("click",()=>{introJs().setOptions({steps:[{element:document.querySelector("#app"),intro:"This design closely follows a link-state routing protocol, so each router knows about their neighbors.",position:"right"},{element:document.querySelector("#app"),intro:`There are 2 phases:<br>
        <ol>
        <li>Each router communicates to all other routers about their local topology by means of <strong>realiable flooding</strong></li>
        <li>Each router computes the best path to take using some algorithm such as Dijkstra\u02BCs algorithm</li>
        </ol> 
        `,position:"left"},{element:document.querySelector("#sourceSelect"),intro:"This is where you select the source router to send the packets.",position:"bottom"},{element:document.querySelector("#targetSelect"),intro:"This is where you select the target router to receive the packets.",position:"top"},{element:document.querySelector("#toggleRT"),intro:"This is the routing information base (RIB). It's a set of rules that determines where packets should be sent.",position:"top"},{element:document.querySelector("#toggleRT"),intro:"Clicking this will reveal the routing table.",position:"top"},{element:document.querySelector("canvas"),intro:"This is the interactive mesh network.",position:"left"},{element:document.querySelector("canvas"),intro:"To update a link cost, click the link/edge and set a new cost",position:"right"},{element:document.querySelector("canvas"),intro:"To destroy a link, click the link/edge and set the cost to -1",position:"right"},{element:document.querySelector("canvas"),intro:"To destroy a router, click the router.",position:"left"},{element:document.querySelector("canvas"),intro:"To restore a router, click the router again.",position:"left"},{element:document.querySelector("canvas"),intro:"The packets may be rerouted for the next best path possible using Dijkstra's algorithm",position:"right"}]}).start()});a.on("node:click",l=>{const t=l.item.getModel().img===x?{type:"image",img:R,size:40}:{type:"image",img:x,size:40};l.item.update(t);let e=S(),n=e[0].value,r=e[1].value,s=a.save();I(s,n),E(s,n,r)});a.on("node:mouseenter",function(l){const t=l.item;a.setAutoPaint(!1),a.setItemState(t,"highlight",!0),a.getEdges().forEach(function(e){!e.destroyed&&e.getSource()===t?(a.setItemState(e.getTarget(),"highlight",!0),a.setItemState(e,"highlight",!0),e.toFront()):!e.destroyed&&e.getTarget()===t?(a.setItemState(e.getSource(),"highlight",!0),a.setItemState(e,"highlight",!0),e.toFront()):e.destroyed||a.setItemState(e,"highlight",!1)}),a.paint(),a.setAutoPaint(!0)});a.on("node:mouseleave",C);a.on("canvas:click",C);a.data(b);a.render();function S(){let l=document.getElementById("sourceSelect"),t=document.getElementById("targetSelect"),e=l.options[l.selectedIndex],n=t.options[t.selectedIndex];return[e,n]}document.getElementById("toggleRT").addEventListener("click",function(l){document.getElementById("toggleRT").innerText==="Show Routing Table"?document.getElementById("toggleRT").innerHTML="Hide Routing Table":document.getElementById("toggleRT").innerHTML="Show Routing Table"});document.getElementsByClassName("form-select")[0].addEventListener("change",function(){let l=S(),t=l[0].value,e=l[1].value;I(b,t),E(b,t,e)});document.getElementsByClassName("form-select")[1].addEventListener("change",function(){let l=S(),t=l[0].value,e=l[1].value;E(b,t,e)});E(b);I(b,"node1");function E(l,t="node1",e="node14"){let n={},r={};k={};let s=document.getElementById("sourceSelect"),c=document.getElementById("targetSelect");s.innerHTML="",c.innerHTML="";for(let o of l.nodes){r[o.id]=o.img===R;let d=document.createElement("option"),h=document.createElement("option");d.value=o.id,d.innerText=o.label,d.selected=o.id===t,h.value=o.id,h.innerText=o.label,h.selected=o.id===e,s.appendChild(d),c.appendChild(h)}for(let o of l.edges){if(a.updateItem(o.id,{type:"cubic",style:{stroke:"#bae7ff"}}),r[o.source]||r[o.target]){k[o.id]=!0;continue}k[o.id]=!1,o.label!=="X"&&(n[o.source]=Object.assign({[o.target]:o.label},n[o.source]),n[o.target]=Object.assign({[o.source]:o.label},n[o.target]))}let i=new B(n).findShortestPath([t,e]),y=[];if(i==null){let o=document.getElementById("liveToast");document.getElementById("toast-msg").textContent=`Cannot send packets from Router ${t.replace(/^\D+/g,"")} to Router ${e.replace(/^\D+/g,"")}.`,new bootstrap.Toast(o).show();return}if(i.length<2){let o=document.getElementById("liveToast2");document.getElementById("toast-msg2").textContent="Source router is the same as the target router.",new bootstrap.Toast(o).show()}for(let o=0;o<i.length-1;++o){y.push({source:i[o],target:i[o+1]});for(let d of l.edges)(d.source===i[o]&&d.target===i[o+1]||d.source===i[o+1]&&d.target===i[o])&&(d.source===i[o+1]&&d.target===i[o]&&([d.source,d.target]=[d.target,d.source],d.id,d.target,d.source,a.changeData(l)),function(h,p){setTimeout(function(){a.updateItem(p.id,{type:"line-dash",style:{stroke:"#6495ED"}})},h*700)}(o,d))}}
